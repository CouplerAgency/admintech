name: Build and release preview
permissions:
  contents: write

on:
  push:
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  ci:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - id: framer
        run: bun run framer
        continue-on-error: true
      - id: build
        run: bun run build
        continue-on-error: true
      - id: deploy
        run: bunx unframer-deploy-demo@latest --secret df8418aa906e0e4a --slug fjellheimen-630e3 --dir ./dist
        continue-on-error: true
      - name: Commit & push (if changed)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git pull --rebase origin "${{ github.ref_name }}" || true
          git commit -m "chore: automated update [skip ci]"
          git push origin HEAD:"${{ github.ref_name }}" || true
      - name: Auto-fix with OpenCode on failure
        if: ${{ (steps.framer.outcome == 'failure' || steps.build.outcome == 'failure' || steps.deploy.outcome == 'failure') && !cancelled() }}
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          npm install -g opencode-ai
          opencode run --model opencode/kimi-k2 "The GitHub Actions workflow at .github/workflows/ci.yml just failed during CI. You are OpenCode running inside a post-failure handler with up to five minutes to work. Read the file at .github/workflows/ci.yml so you understand the steps and repeat them. Try to run those workflow steps again locally (bun run framer, bun run build, bunx unframer-deploy-demo), fix any issues that appear, rerun until they pass. If some imported files in App.tsx do not exist just remove them. After fixing and getting all steps to pass, commit and push the fixes just like the workflow does. Then exit with code 0 to mark the CI as successful. If you cannot fix the issues, exit with code 1."